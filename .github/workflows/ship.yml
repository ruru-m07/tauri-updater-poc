name: ship

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump (required only for first prerelease or stable)'
        required: true
        type: choice
        options:
          - none
          - patch
          - minor
          - major

      prerelease:
        description: 'Prerelease identifier (beta, rc, alpha)'
        required: false
        type: string

concurrency:
  group: ship-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Build & Release Tauri App
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # required for changelog

      # ----------------------------
      # Tooling
      # ----------------------------
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      # ----------------------------
      # Dependencies
      # ----------------------------
      - name: Install JS deps
        run: bun install

      # ----------------------------
      # Release-it config (inline, clean)
      # ----------------------------
      - name: Create release-it config
        run: |
          cat <<'EOF' > .release-it.json
          {
            "git": {
              "commitMessage": "chore(release): v${version}",
              "tagName": "v${version}",
              "push": true
            },
            "github": {
              "release": true,
              "draft": ${{
                inputs.prerelease == '' && 'true' || 'false'
              }},
              "prerelease": ${{
                inputs.prerelease != '' && 'true' || 'false'
              }}
            },
            "plugins": {
              "@release-it/conventional-changelog": {
                "preset": "conventionalcommits"
              }
            },
            "npm": false
          }
          EOF

      # ----------------------------
      # Version bump + tag + changelog
      # ----------------------------
      - name: Run release-it
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ inputs.bump }}" = "none" ] && [ -n "${{ inputs.prerelease }}" ]; then
            # prerelease iteration: 0.4.0-beta.1 → 0.4.0-beta.2
            bunx release-it --preRelease=${{ inputs.prerelease }} --ci

          elif [ "${{ inputs.bump }}" != "none" ] && [ -n "${{ inputs.prerelease }}" ]; then
            # first prerelease
            bunx release-it pre${{ inputs.bump }} \
              --preRelease=${{ inputs.prerelease }} \
              --ci

          elif [ "${{ inputs.bump }}" != "none" ]; then
            # stable release
            bunx release-it ${{ inputs.bump }} --ci

          else
            echo "❌ Invalid input combination"
            exit 1
          fi


      # ----------------------------
      # Build Tauri
      # ----------------------------
      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          args: --target universal-apple-darwin

      # ----------------------------
      # Publish stable draft
      # ----------------------------
      - name: Publish draft release (stable only)
        if: inputs.prerelease == ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit \
            "$(git describe --tags --abbrev=0)" \
            --draft=false
